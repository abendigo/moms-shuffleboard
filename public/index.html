<!DOCTYPE html>
<html>
  <head>
    <!-- <link href='https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons' rel="stylesheet"> -->
    <!-- <link href="https://cdn.jsdelivr.net/npm/vuetify/dist/vuetify.min.css" rel="stylesheet"> -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

    <script src="https://unpkg.com/vue/dist/vue.js"></script>
    <script src="https://unpkg.com/vue-router/dist/vue-router.js"></script>
    <script src="https://unpkg.com/vuex/dist/vuex.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/vuetify/dist/vuetify.js"></script> -->

    <!-- <script src="https://www.gstatic.com/firebasejs/5.3.1/firebase.js"></script> -->
    <script src="https://www.gstatic.com/firebasejs/5.2.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.2.0/firebase-firestore.js"></script>

    <script>
      // Initialize Firebase
      const config = {
        apiKey: "AIzaSyDAx27-_XF2eM7wXiedd7goKm5p1fMONfs",
        authDomain: "moms-shuffleboard.firebaseapp.com",
        databaseURL: "https://moms-shuffleboard.firebaseio.com",
        projectId: "moms-shuffleboard",
        storageBucket: "moms-shuffleboard.appspot.com",
        messagingSenderId: "154777839060"
      };
      firebase.initializeApp(config);
    </script>

    <script>
      const firestore = firebase.firestore();
      const settings = {/* your settings... */ timestampsInSnapshots: true};
      firestore.settings(settings);

      // firestore.collection("teams").get().then((querySnapshot) => {
      firestore.collection("teams").onSnapshot((querySnapshot) => {
        let teams = {};
        querySnapshot.forEach((doc) => {
            console.log(`${doc.id} => ${JSON.stringify(doc.data())}`);
            teams[doc.id] = doc.data();
            // teams.push(Object.assign({
            //   did: doc.id
            // }, doc.data()));
        });
        console.log(teams);
        store.commit('setTeams', teams);
      });
    </script>
    <style>
      table {
          border-collapse: collapse;
      }

      table, th, td {
          border: 1px solid black;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <ul>
        <li v-for="team, index of teams">
          <ol>
            <li>{{ team.member_1 }}</li>
            <li>{{ team.member_2 }}</li>
          </ol>
          <button v-on:click="onDelete(index)">delete</button>
        </li>
      </ul>

      <form v-on:submit.prevent="processForm">
        <input type="text" placeholder="First Team Member" v-model="form.member_1">
        <input type="text" placeholder="Second Team Member" v-model="form.member_2">
        <input type="submit">
      </form>

      <button @click="generateSchedule">Generate Schedule</button>

      <table style="border: 4px solid black;">
        <thead>
          <tr>
            <th></th>
            <th v-for="date in dates">{{date}}</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="timeslot in timeslots">
            <td>{{timeslot}}</td>
            <td v-for="date in dates">
              <ul>
                <li v-for="team in schedule[date][timeslot]">
                  <ol>
                    <li>{{ getTeam(team).member_1 }}</li>
                    <li>{{ getTeam(team).member_2 }}</li>
                  </ol>
                </li>
              </ul>
            </td>
          </tr>
        </tbody>
      </table>


      <h2>Router Links</h2>
      <router-link to="/schedule">Schedule</router-link>
      <router-link to="/teams">Teams</router-link>
      <h2>Router Outlet</h2>
      <router-view></router-view>
    </div>
  </body>

  <script>
    const Foo = { template: '<div>foo</div>' }
    const Bar = { template: '<div>bar</div>' }

    const routes = [
      { path: '/foo', component: Foo },
      { path: '/bar', component: Bar }
    ]

    const router = new VueRouter({
      routes // short for `routes: routes`
    })
  </script>

  <script>
    const store = new Vuex.Store({
      state: {
        teams: []
      },
      mutations: {
        setTeams(state, teams) { state.teams = teams; }
      }
    });
  </script>

  <script>
    const app = new Vue({
      el: '#app',
      router: router,
      store: store,
      computed: Vuex.mapState({
        teams: 'teams'
      }),
      data: {
        form: {
          member_1: '',
          member_2: ''
        },
        timeslots: ['13:00', '14:00', '15:00'],
        dates: [
          'Sep 24', 'Oct 01', 'Oct 08', 'Oct 15', 'Oct 22',
          'Oct 29', 'Nov 05', 'Nov 12', 'Nov 19', 'Nov 26'],
        schedule: {
          'Sep 24': {'13:00': [], '14:00': [], '15:00': []},
          'Oct 01': {'13:00': [], '14:00': [], '15:00': []},
          'Oct 08': {'13:00': [], '14:00': [], '15:00': []},
          'Oct 15': {'13:00': [], '14:00': [], '15:00': []},
          'Oct 22': {'13:00': [], '14:00': [], '15:00': []},
          'Oct 29': {'13:00': [], '14:00': [], '15:00': []},
          'Nov 05': {'13:00': [], '14:00': [], '15:00': []},
          'Nov 12': {'13:00': [], '14:00': [], '15:00': []},
          'Nov 19': {'13:00': [], '14:00': [], '15:00': []},
          'Nov 26': {'13:00': [], '14:00': [], '15:00': []}
        }
      },

      methods: {
        processForm: function() {
          console.log('processForm', this.form.member_1, this.form.member_2);

          firestore.collection('teams').add({
            member_1: this.form.member_1,
            member_2: this.form.member_2
          }).then(ref => {
            console.log('success', ref);
          }, error => {
            console.log('error', error);
          });
        },
        onDelete: function(id) {
          console.log('onDelete', id)

          firestore.collection('teams').doc(id).delete().then(() => {
            console.log('deleted')
          }, error => {
            console.log('error', error)
          })
        },
        getTeam: function(id) {
          return this.teams[id] || {};
        },
        shuffleArray(array) {
          for (let i = array.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [array[i], array[j]] = [array[j], array[i]];
          }
        },
        generateSchedule: function() {
          console.log('generateSchedule', this.teams)

          let schedule = {};

          const slotCount = this.timeslots.length;
          for (let date of this.dates) {
            schedule[date] = {};

            // get a list of keys
            let ids = Object.keys(this.teams);
            this.shuffleArray(ids);

            // randomize starting location, incase the number of teams
            // is not evenly divisible
            let slotIndex = Math.floor(Math.random() * slotCount);
            console.log(date, 'slot', slotIndex)

            for (let id of ids) {
              let timeslot = this.timeslots[slotIndex];
              console.log('---', id, slotIndex, timeslot)

              if (!schedule[date][timeslot])
                schedule[date][timeslot] = [];
              schedule[date][timeslot].push(id);

              slotIndex = (slotIndex + 1) % slotCount;
            }

            console.log('==================')
          }

          console.log('schedule', schedule)
          this.schedule = schedule;
        }
      }
    });
  </script>
</html>
